<html>

<head>
    <title>Video live streaming</title>
    <style>
        #videoFrame {
            text-align: center;
        }

        #buttonFrame {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            margin-left: 30%;
            margin-right: 30%;
        }

        #logDiv {
            text-align: center;
            margin: 16px;
        }

        button {
            width: 64px;
        }
    </style>
</head>

<body>
    <div id="videoFrame"> <video width="640" height="480" id="vidTag" muted controls autoplay> </video></div>
    <div id="logDiv">Log</div>
    <div>
        <div id="buttonFrame">
            <button onclick="location.reload()">Reload</button>
            <button onclick="stopStreaming().then(()=>alert('Streaming stopped'))">Stop</button>
        </div>
    </div>
    <script>
        //Logging function
        const log = log => logDiv.innerText = log

        //Set mediaSource
        const mediaSource = new MediaSource();
        const url = URL.createObjectURL(mediaSource);
        vidTag.src = url;

        //When source opend
        mediaSource.addEventListener('sourceopen', () => startStreaming())

        //Process streaming
        var loadProcessID = -1

        const waitPromise = (time) => new Promise((resolve, reject) => setTimeout(() => resolve(), time))

        function startStreaming() {
            if (mediaSource.readyState != 'open') return false
            if (loadProcessID > 0) return false
            stopStreaming()
                .then(json => {
                    if (!json) new Error('Server stoppeds')
                    if (!json.success) new Error('Can\'t stop streaming')
                })
                .then(() => log('Waiting for camera preparing(3sec)'))
                .then(() => waitPromise(3000))
                .then(() => {
                    log('Start streaming. Buffering... (It would take 10~20 sec)')
                    const videoQueue = []

                    let loading = false                                             //Loading check flag
                    loadProcessID = setInterval(() => {
                        if (loading) return                                         //Check if previous task running
                        loading = true
                        date = Date.now()
                        fetch("/video/" + date)    //Load data
                            .then(response => response.arrayBuffer())               //Convert data
                            .then(videoData => {
                                if (videoData && videoData.byteLength > 1) {
                                    videoQueue.push(videoData)
                                    // console.log('Got : ' + videoData.byteLength)
                                } else {
                                    // console.log('.')
                                }
                            }).then(() => loading = false)
                    }, 500);

                    //Create buffer
                    const videoSourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"')
                    videoSourceBuffer.addEventListener('updateend', () => appendVideo());

                    //Append video
                    function appendVideo() {
                        if (loadProcessID < 0) return
                        setTimeout(() => {
                            if (videoQueue.length > 0) {
                                const buffer = videoQueue.shift()
                                videoSourceBuffer.appendBuffer(buffer)
                                log('Video clip added at ' + new Date())
                            } else appendVideo()
                        }, 500);
                    }
                    appendVideo()
                })
                .catch(err => {
                    console.error(err)
                    alert('Error occured : ' + err)
                    stopStreaming().then(json => {
                        if (!json) return alert('Server stopped')
                        if (!json.success) return alert('Can\'t stop streaming')
                    })
                })
        }

        function stopStreaming() {
            if (loadProcessID > 0) clearInterval(loadProcessID)
            loadProcessID = -1
            return fetch('/close')
                .then(res => res.arrayBuffer())
                .then(data => JSON.stringify(new TextDecoder('utf-8').decode(data)))
        }
    </script>
</body>

</html>